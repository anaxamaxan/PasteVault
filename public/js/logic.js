$(document).ready(function(){
	// Setup captcha	
	$('.QapTcha').QapTcha({
		PHPfile: 'captcha',
		txtLock: '',
		txtUnlock: '',
		autoSubmit: true
	});

	// Setup copy to clipboard
	$('#copy_button').zclip({
	    path: 'swf/ZeroClipboard.swf',
	    copy: function(){return $('#copy_text').val();},
	    afterCopy: function(){ 
	    	$('#results').html($('#copied').html());
	    	setTimeout(function(){
	    		window.location.reload(); 
	    	}, 2000);
	    },
	});		
		

	// Encrypt!
	$('#create_form').submit(function(){
		// Encrypt!
		var secure_text = sjcl.encrypt($('#password').val(), $('#textbox').val());

		// Base64 encode
		encoded_secure_text = $.base64.encode(secure_text);

		// Random post field generated by the captcha
		var qaptcha_field = $("input[type='hidden']").attr('name');

		// Setup form data to send to server
		var params = {};
		params['expire'] 	  = $('#expire').val();
		params['text'] 		  = encoded_secure_text;

		// Note this is tricky. It will be empty if captcha is working correctly
		params[qaptcha_field] = $("input[type='hidden']").val(); 

		// Save it
		$.post("save", params,
			function(data) {
				// Put link in textarea & password in view box
				$('#view_password').html($('#password').val());
				$('#copy_text').val(data);
			}
		);

		// Show modal with results
		$('#results').reveal({
			closeonbackgroundclick: false,
			dismissmodalclass: 'close',
		});

		// Reset Qaptcha (how?)

		// Don't really submit form
		return false;
	});

	// Show encrypted data if asked
	$('#show_me').click(function(){
		$('#encrypted_text').toggle();

		return false;
	});

	// Decrypt text
	$('#display_message').click(function(){
		// Base64 decode
		var encrypted_text = $.base64.decode($('#view_body').html());

		// Decrypt!
		try
		{
			var open_text = sjcl.decrypt($('#decrypt_password').val(), encrypted_text);	
			$('#get_password').hide();
			$('#view_body').html(open_text);
		}
		catch(err)
		{
			// Didn't work show error
		}

		return false;
	});
});